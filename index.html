<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cat√°logo Muebler√≠a Jhoseby</title>
  <style>
    :root {
      --verde: #2ecc71;
      --verde-oscuro: #27ae60;
      --azul: #3498db;
      --azul-oscuro: #2980b9;
      --gris-oscuro: #2c3e50;
      --gris-claro: #ecf0f1;
      --rojo: #e74c3c;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
    }
    body.light-mode {
      background-color: #f7f9fa;
      color: #333;
    }
    body.dark-mode {
      background-color: #1e1e1e;
      color: #eee;
    }
    header {
      background-color: var(--verde);
      color: white;
      padding: 2px;
      text-align: center;
      position: relative;
    }
    #toggle-theme {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 8px 14px;
      background-color: white;
      color: var(--verde);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .catalogo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 24px;
      padding: 30px;
    }
    .producto {
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.2s ease-in-out;
    }
    body.light-mode .producto {
      background-color: white;
    }
    body.dark-mode .producto {
      background-color: #2b2b2b;
    }
    .producto:hover {
      transform: translateY(-5px);
    }
    .producto img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
    }
    .producto img:hover {
      transform: scale(1.02);
    }
    .producto h3 {
      margin: 4px 0 2px;
    }
    .producto p {
      margin-bottom: 2px;
      font-weight: bold;
    }
    .producto button {
      background-color: var(--verde);
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .producto button:hover {
      background-color: var(--verde-oscuro);
    }
    #carrito-container {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 320px;
      max-height: 85vh;
      overflow-y: auto;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }
    body.light-mode #carrito-container {
      background-color: white;
    }
    body.dark-mode #carrito-container {
      background-color: #2b2b2b;
    }
    #carrito-container h2 {
      margin: 0 0 20px;
      font-size: 1.4rem;
      color: var(--verde);
      border-bottom: 2px solid var(--verde);
      padding-bottom: 10px;
    }
    #carrito {
      list-style: none;
      padding: 0;
      margin-bottom: 15px;
    }
    #carrito li {
      margin-bottom: 10px;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #carrito li button {
      background: var(--rojo);
      border: none;
      color: white;
      padding: 2px 6px;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
    }
    input[type="text"], input[type="number"]  {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    #enviarBtn {
      background-color: var(--azul);
      border: none;
      color: white;
      padding: 10px;
      width: 100%;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    #enviarBtn:hover {
      background-color: var(--azul-oscuro);
    }
    #enviarBtn:disabled {
      background-color: #b5cde6;
      cursor: not-allowed;
      opacity: 0.75;
    }
    .mensaje-adelanto {
      font-size: 13px;
      margin-bottom: 8px;
    }
    .mensaje-adelanto.error { color: var(--rojo); }
    .mensaje-adelanto.ok { color: var(--verde-oscuro); }
    .nota-fija {
      font-size: 12px;
      color: #555;
      margin-bottom: 6px;
    }
    @media (max-width: 768px) {
      #carrito-container {
        position: static;
        width: 100%;
        margin: 20px auto;
        box-shadow: none;
        max-height: none;
      }
    }
    
    /* Estilos espec√≠ficos para el modal de imagen */
    .modal-imagen {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.9);
    }
    .modal-imagen-contenido {
      position: relative;
      margin: 5% auto;
      width: 90%;
      max-width: 800px;
      text-align: center;
    }
    .modal-imagen img {
      width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .modal-imagen-info {
      background-color: white;
      color: #333;
      padding: 15px;
      margin-top: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    body.dark-mode .modal-imagen-info {
      background-color: #2b2b2b;
      color: #eee;
    }
    .cerrar-imagen {
      position: absolute;
      top: -40px;
      right: 0;
      color: white;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
      background-color: rgba(0,0,0,0.5);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s;
    }
    .cerrar-imagen:hover {
      background-color: var(--rojo);
    }
    @media (max-width: 768px) {
      .modal-imagen-contenido {
        margin: 2% auto;
        width: 95%;
      }
      .cerrar-imagen {
        top: -35px;
        right: 5px;
        font-size: 30px;
        width: 35px;
        height: 35px;
      }
    }
  </style>
</head>
<body class="light-mode">
  <header>
    <h1>Cat√°logo Muebler√≠a Jhoseby</h1>
    <button id="toggle-theme">üåô Modo Oscuro</button>
  </header>

  <div class="catalogo" id="catalogo"></div>

  <div id="carrito-container">
    <h2>üõí Carrito de Compras</h2>
    <ul id="carrito"></ul>

    <!-- Opciones de m√©todo de pago -->
    <div id="metodo-pago" style="margin-bottom: 12px;">
      <strong>Seleccione el M√©todo de Pago:</strong><br>
      <label><input type="radio" name="pago" value="Efectivo" checked> Efectivo</label>
      <label><input type="radio" name="pago" value="Transferencia"> Transferencia</label>
      <label><input type="radio" name="pago" value="Cr√©dito"> Cr√©dito</label>
    </div>

    <!-- Total ajustado -->
    <div id="total-ajustado" style="font-weight:bold; margin-bottom: 12px;">Total: $ 0.00</div>

    <input type="text" id="cliente" placeholder="Nombre del cliente" />
    <input type="number" id="adelanto" placeholder="Se√±a" />
    <div id="mensajeAdelanto" class="mensaje-adelanto error">Para realizar el pedido trabajamos con una se√±a m√≠nimo de $100.000 El tiempo de entrega es de 20 a 30 d√≠as.</div>
    <button id="enviarBtn" onclick="enviarPedido()" disabled>Enviar Pedido</button>
  </div>

  <!-- MODAL PARA IM√ÅGENES DE PRODUCTOS -->
  <div id="modalImagen" class="modal-imagen">
    <div class="modal-imagen-contenido">
      <span class="cerrar-imagen">&times;</span>
      <img id="imagenAmpliada" src="" alt="">
      <div class="modal-imagen-info">
        <h3 id="nombreProducto"></h3>
        <p id="precioProducto"></p>
        <p id="stockProducto"></p>
      </div>
    </div>
  </div>

  <script>
    const urlProductos = "https://opensheet.elk.sh/1ACt8W6my4lA7pCWvgNEUjoQxhdcUpn9OlOLlGO6AFb4/Productos";
    // Nueva URL para obtener las ventas y determinar el pr√≥ximo ID
    const urlVentas = "https://opensheet.elk.sh/1ACt8W6my4lA7pCWvgNEUjoQxhdcUpn9OlOLlGO6AFb4/Ventas";
    const urlAppScript = "https://script.google.com/macros/s/AKfycbxZ3n7BjXBvbHF6-7jEzNpmWUldyWAEe_9OytuYzSpyzBHGSFzPPtopa_LzPJUREoXf_g/exec";
    const numeroWhatsApp = "5493886535151";

    let carrito = [];
    let productosData = [];
    let metodoPagoSeleccionado = "Efectivo";
    let proximoIdVenta = "V-0001"; // Valor por defecto

    const body = document.body;
    const themeToggle = document.getElementById("toggle-theme");
    const currentTheme = localStorage.getItem("theme") || "light";
    setTheme(currentTheme);

    themeToggle.onclick = () => {
      const nuevoTema = body.classList.contains("light-mode") ? "dark" : "light";
      setTheme(nuevoTema);
    };

    function setTheme(mode) {
      body.classList.toggle("dark-mode", mode === "dark");
      body.classList.toggle("light-mode", mode === "light");
      themeToggle.textContent = mode === "dark" ? "‚òÄÔ∏è Modo Claro" : "üåô Modo Oscuro";
      localStorage.setItem("theme", mode);
    }

    // Funci√≥n para obtener el pr√≥ximo ID de venta
    async function obtenerProximoIdVenta() {
      try {
        const response = await fetch(urlVentas);
        const ventas = await response.json();
        
        if (!ventas || ventas.length === 0) {
          return "V-0001";
        }

        // Filtrar solo los IDs que siguen el patr√≥n V-XXXX
        const idsValidos = ventas
          .map(venta => venta.Id_Venta)
          .filter(id => id && id.startsWith('V-') && id.length === 6)
          .map(id => parseInt(id.substring(2))) // Extraer el n√∫mero despu√©s de "V-"
          .filter(num => !isNaN(num)); // Filtrar n√∫meros v√°lidos

        if (idsValidos.length === 0) {
          return "V-0001";
        }

        // Encontrar el m√°ximo n√∫mero y sumar 1
        const maxNumero = Math.max(...idsValidos);
        const siguienteNumero = maxNumero + 1;
        
        // Formatear con ceros a la izquierda (4 d√≠gitos)
        return `V-${siguienteNumero.toString().padStart(4, '0')}`;
      } catch (error) {
        console.error('Error al obtener ventas:', error);
        // En caso de error, usar un ID basado en timestamp para evitar duplicados
        const timestamp = Date.now().toString().slice(-4);
        return `V-${timestamp}`;
      }
    }

     // Funci√≥n para generar un ID √∫nico
  function generarUniqueId() {
    return Math.random().toString(36).substr(2, 8).toLowerCase();
  }

    // Cargar productos y obtener pr√≥ximo ID
    Promise.all([
      fetch(urlProductos).then(res => res.json()),
      obtenerProximoIdVenta()
    ]).then(([productosResponse, idVenta]) => {
      productosData = productosResponse;
      proximoIdVenta = idVenta;
      console.log('Pr√≥ximo ID de venta:', proximoIdVenta);
      
      const catalogo = document.getElementById("catalogo");
      productosResponse.forEach((producto, index) => {
        const div = document.createElement("div");
        div.className = "producto";
        div.setAttribute("data-id", producto.Id_Producto);
        div.innerHTML = `
          <img src="${producto.Imagen_URL}" 
               alt="${producto.Codigo}" 
               onclick="abrirModalImagen('${producto.Imagen_URL}', '${producto.Descripcion}', '${producto.Precio_Venta}', '${producto.Stock_Actual}')"
               title="Clic para ampliar imagen">
          <h3>${producto.Descripcion}</h3>
          <p>$ ${producto.Precio_Venta}</p>
          <p class="stock">Stock Disponible: <span id="stock-${index}">${producto.Stock_Actual}</span></p>
          <button onclick='agregarAlCarrito(${index})'>Agregar</button>
        `;
        catalogo.appendChild(div);
      });
    }).catch(error => {
      console.error('Error al cargar datos:', error);
      alert('Error al cargar los productos. Por favor, recarga la p√°gina.');
    });

    document.querySelectorAll('input[name="pago"]').forEach(radio => {
      radio.addEventListener("change", e => {
        metodoPagoSeleccionado = e.target.value;
        renderizarCarrito();
      });
    });

    function agregarAlCarrito(index) {
      const producto = productosData[index];
      if (parseInt(producto.Stock_Actual) <= 0) return alert("Producto sin stock disponible.");
      const existente = carrito.find(p => p.Id_Producto === producto.Id_Producto);
      if (existente) existente.cantidad++;
      else carrito.push({ Id_Producto: producto.Id_Producto, Codigo: producto.Codigo, Descripcion: producto.Descripcion, Precio: parseFloat(producto.Precio_Venta), cantidad: 1 });
      productosData[index].Stock_Actual--;
      document.getElementById(`stock-${index}`).textContent = productosData[index].Stock_Actual;
      renderizarCarrito();
    }

    function quitarUnidad(index) {
      const producto = carrito[index];
      const prodIndex = productosData.findIndex(p => p.Id_Producto === producto.Id_Producto);
      if (prodIndex !== -1) productosData[prodIndex].Stock_Actual++;
      document.getElementById(`stock-${prodIndex}`).textContent = productosData[prodIndex].Stock_Actual;
      if (producto.cantidad > 1) producto.cantidad--;
      else carrito.splice(index, 1);
      renderizarCarrito();
    }

    function renderizarCarrito() {
      const ul = document.getElementById("carrito");
      ul.innerHTML = "";
      let total = 0;
      carrito.forEach((p, i) => {
        const subtotal = p.Precio * p.cantidad;
        total += subtotal;
        const li = document.createElement("li");
        li.innerHTML = `<span>${p.Codigo} - ${p.Descripcion} x${p.cantidad}</span><span>$ ${Math.round(subtotal)} <button onclick="quitarUnidad(${i})">-</button></span>`;
        ul.appendChild(li);
      });
      const totalLi = document.createElement("li");
      totalLi.style.fontWeight = "bold";
      totalLi.style.borderTop = "1px solid #ccc";
      totalLi.style.paddingTop = "8px";
      totalLi.innerHTML = `<span>Total:</span><span>$ ${Math.round(total)}</span>`;
      ul.appendChild(totalLi);

      let totalAjustado = total;
      if (metodoPagoSeleccionado === "Efectivo") totalAjustado *= 0.92;
      else if (metodoPagoSeleccionado === "Cr√©dito") totalAjustado *= 1.12;

      document.getElementById("total-ajustado").textContent = `Total (${metodoPagoSeleccionado}): $ ${Math.round(totalAjustado)}`;
    }

    // VALIDACI√ìN EN TIEMPO REAL DE LA SE√ëA
    const SE√ëA_MINIMA = 100000;
    const adelantoInput = document.getElementById("adelanto");
    const mensajeAdelanto = document.getElementById("mensajeAdelanto");
    const enviarBtn = document.getElementById("enviarBtn");

    function validarAdelanto() {
      const valor = parseFloat(adelantoInput.value);
      if (isNaN(valor) || valor < SE√ëA_MINIMA) {
        mensajeAdelanto.classList.remove("ok");
        mensajeAdelanto.classList.add("error");
        mensajeAdelanto.textContent = `Para realizar el pedido trabajamos con una se√±a m√≠nimo de $${SE√ëA_MINIMA.toLocaleString('es-AR')} El tiempo de entrega es de 20 a 30 d√≠as.`;
        enviarBtn.disabled = true;
        return false;
      } else {
        mensajeAdelanto.classList.remove("error");
        mensajeAdelanto.classList.add("ok");
        mensajeAdelanto.textContent = `Se√±a v√°lida: $${Math.round(valor)} ‚Äî puedes realizar el pedido.`;
        enviarBtn.disabled = false;
        return true;
      }
    }

    adelantoInput.addEventListener("input", validarAdelanto);
    validarAdelanto();

    async function enviarPedido() {
      if (carrito.length === 0) return alert("El carrito est√° vac√≠o.");
      const nombreCliente = document.getElementById("cliente").value.trim();
      const adelantoCliente = document.getElementById("adelanto").value.trim();
      if (!nombreCliente) return alert("Por favor, ingresa el nombre del cliente.");
      if (!adelantoCliente) return alert("Por favor, ingresa la Se√±a.");

      // Obtener un nuevo ID de venta justo antes de enviar
      const idVentaActual = await obtenerProximoIdVenta();
      
      const fecha = new Date().toLocaleString("es-AR", { timeZone: "America/Argentina/Buenos_Aires" });
      const productos = carrito.map(p => ({
        Id_Detalle: generarUniqueId(),
        Id_Venta: idVentaActual,
        Id_Producto: p.Id_Producto,
        Codigo: p.Codigo,
        Descripcion: p.Descripcion,
        Precio: p.Precio,
        Cantidad: p.cantidad,
        Sub_Total: Math.round(p.Precio * p.cantidad),
        Tipo_Movimiento: "Egresos"
      }));
      const total = productos.reduce((sum, p) => sum + parseFloat(p.Sub_Total), 0);
      let totalAjustado = total;
      if (metodoPagoSeleccionado === "Efectivo") totalAjustado *= 0.92;
      else if (metodoPagoSeleccionado === "Cr√©dito") totalAjustado *= 1.12;

      const datos = {
        id_venta: idVentaActual, // Incluir el ID de venta secuencial
        nombre: nombreCliente,
        metodo_pago: metodoPagoSeleccionado,
        adelanto: adelantoCliente,
        productos
      };

      // Env√≠o a Google Apps Script (no-cors)
      fetch(urlAppScript, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });

      let mensaje = `ü™ë *Nuevo Pedido - Muebler√≠a Jhoseby*%0Aüî¢ ID Venta: ${idVentaActual}%0Aüë§ Cliente: ${nombreCliente}%0Aüí∞ Se√±a: $ ${adelantoCliente}%0A`;
      productos.forEach(p => {
        mensaje += `üîπ ${p.Codigo} - ${p.Cantidad} x $ ${Math.round(p.Precio)} = $ ${p.Sub_Total}%0A`;
      });
      mensaje += `üìã *Total (${metodoPagoSeleccionado}): $ ${Math.round(totalAjustado)}*%0Aüóì ${fecha}`;
      window.open(`https://wa.me/${numeroWhatsApp}?text=${mensaje}`, "_blank");

      carrito = [];
      renderizarCarrito();
      document.getElementById("cliente").value = "";
      document.getElementById("adelanto").value = "";
      
      // Actualizar el pr√≥ximo ID para la siguiente venta
      proximoIdVenta = await obtenerProximoIdVenta();
      
      alert(`‚úÖ Pedido enviado y registrado con ID: ${idVentaActual}`);
    }

    // Funciones para el modal de im√°genes
    const modalImagen = document.getElementById("modalImagen");
    const cerrarModalImagen = document.querySelector(".cerrar-imagen");
    const imagenAmpliada = document.getElementById("imagenAmpliada");
    const nombreProducto = document.getElementById("nombreProducto");
    const precioProducto = document.getElementById("precioProducto");
    const stockProducto = document.getElementById("stockProducto");

    function abrirModalImagen(imagenUrl, descripcion, precio, stock) {
      imagenAmpliada.src = imagenUrl;
      imagenAmpliada.alt = descripcion;
      nombreProducto.textContent = descripcion;
      precioProducto.textContent = `Precio: $ ${precio}`;
      stockProducto.textContent = `Stock disponible: ${stock} unidades`;
      modalImagen.style.display = "block";
    }

    cerrarModalImagen.onclick = () => modalImagen.style.display = "none";

    window.onclick = e => {
      if (e.target === modalImagen) modalImagen.style.display = "none";
    };

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        modalImagen.style.display = "none";
      }
    });
  </script>
</body>
</html>
